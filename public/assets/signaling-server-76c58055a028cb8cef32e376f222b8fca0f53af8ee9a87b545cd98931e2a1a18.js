function hasTimeLeft(e){return new Date(e).getTime()-(new Date).getTime()>0}function setVideoDevicesLabels(){$("#videoDevicesList").html("");videoDevices.map(function(e){return{label:e.label,deviceId:e.deviceId}}).forEach(function(e){var t=$('<a data-turbolinks="false" class="dropdown-item fsz-14" href="#">'+e.label+"</a>");t.on("click",function(){switchCameras(e.deviceId)}),$("#videoDevicesList").append(t)})}function countdown_timer(e){countDownDate=new Date(e).getTime();var t=setInterval(function(){var e=(new Date).getTime(),o=countDownDate-e,n=Math.floor(o/864e5),a=Math.floor(o%864e5/36e5),i=Math.floor(o%36e5/6e4),r=Math.floor(o%6e4/1e3);n=n?n+"d ":"",a=a?a+"h ":"",i=i?i+"m ":"",r=r?r+"s ":"",document.getElementById("demo")?(document.getElementById("demo").innerHTML=n+a+i+r,o<0&&(clearInterval(t),document.getElementById("demo").innerHTML="EXPIRED",$("#timesUp").modal({backdrop:"static"}),localStream.getTracks().forEach(function(e){e.stop()}),$("#local-video-right").hide())):clearInterval(t)},1e3)}async function switchCameras(e){if(e)mediaStreamConstraints.video.deviceId={exact:e};else{var t=videoDevices[currentActiveCamera+1];t?(mediaStreamConstraints.video.deviceId={exact:t.deviceId},currentActiveCamera+=1):(mediaStreamConstraints.video.deviceId={exact:videoDevices[0].deviceId},currentActiveCamera=0)}navigator.mediaDevices.getUserMedia(mediaStreamConstraints).then(function(e){Object.keys(pcPeers).length?(replaceTracks(e),localStream=e,localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e):(localStream=e,localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e,document.getElementById("local-video").srcObject=e)})["catch"](function(e){console.log(e)})}function replaceTracks(e){function t(){a.map(function(e){if(e.track){var t=o.find(function(t){return t.kind===e.track.kind});t&&e.replaceTrack(t)}})}var o=e.getTracks(),n=pcPeers[Object.keys(pcPeers)[0]],a=n.getSenders();o.forEach(function(e){localStream.addTrack(e)}),t(n)}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var iceServers=[{urls:["stun:webrtcweb.com:7788","stun:webrtcweb.com:7788?transport=udp"],username:"muazkh",credential:"muazkh"},{urls:["turn:webrtcweb.com:7788","turn:webrtcweb.com:4455?transport=udp","turn:webrtcweb.com:8877?transport=udp","turn:webrtcweb.com:8877?transport=tcp"],username:"muazkh",credential:"muazkh"},{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun.l.google.com:19302?transport=udp"]}];const JOIN_ROOM="JOIN_ROOM",EXCHANGE="EXCHANGE",REMOVE_USER="REMOVE_USER",TOGGLE_VIDEO="TOGGLE_VIDEO";var displayMediaStreamConstraints={video:!0,audio:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseReduction:!1}},mediaStreamConstraints={video:{width:screen.width,height:screen.height,aspectRatio:1.77},audio:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseReduction:!1}};let currentUser,remoteVideoContainer,localStream,videoDevices,seesionId,pcPeers={},iceCandiatesQueue=[];window.onload=(async()=>{currentUser=document.getElementById("current-user").innerHTML,end_time=document.getElementsByTagName("time")[0].innerHTML,countdown_timer(end_time),seesionId=document.getElementById("session_id").innerHTML,peer_user_id=document.getElementById("peer-user").innerHTML,remoteVideoContainer=document.getElementById("remote-video-container");var e=$("#pre_session_start_time"),t=moment(e.attr("data-count-down")).toDate();const o=await navigator.mediaDevices.enumerateDevices();videoDevices=o.filter(e=>"videoinput"===e.kind),setVideoDevicesLabels(),videoDevices.length<2&&$(".pre-session-switch-camera").hide(),$(".dropdown-submenu button.test").on("click",function(e){$(this).next("ul").toggle(),e.stopPropagation(),e.preventDefault()}),moment().isAfter(moment(t))&&$("#join-session-btn").prop("disabled",!1),$("#otherUserEndedSessionConfirmBtn").on("click",function(){$("#timesUp").modal({backdrop:"static"});var e=$("#otherUserDisplayNamePlaceholder").text();$("#timesUpModalTitle").text(e+" has ended the session")}),$("#endSessionConfirmBtn").on("click",function(){handleLeaveSession()}),e.countdown(t,function(e){$(this).text(e.strftime("%H:%M:%S"))}).on("finish.countdown",function(){console.log("finished"),$("#join-session-btn").prop("disabled",!1),e.text("ready")})});const ice={iceServers:iceServers};document.onreadystatechange=(()=>{"interactive"===document.readyState&&navigator.mediaDevices.getUserMedia(mediaStreamConstraints).then(e=>{var t=$("#local-video")[0];localStream=e,t.srcObject=e})["catch"](logError)});const handleJoinSession=async()=>{$(".wrapCardPre").fadeOut(),$("#local-video-up").fadeIn(),$(".session_header_text").show(),localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=localStream,App.session=await App.cable.subscriptions.create({channel:"SessionChannel",session_id:document.getElementById("session_id").innerHTML},{connected:()=>{broadcastData({type:JOIN_ROOM,from:currentUser,session_id:seesionId}),$("#loading").show()},received:e=>{if(console.log("received",e),e.from!==currentUser)switch(e.type){case JOIN_ROOM:return joinRoom(e);case EXCHANGE:if(e.to!==currentUser)return;return exchange(e);case REMOVE_USER:return iceCandiatesQueue.length=0,removeUser(e);default:case TOGGLE_VIDEO:return opponentToggledVideo(e.candidate)}},speak:e=>(console.log("received",e),App.session.perform("speak",{body:e}))})},opponentToggledVideo=e=>{e?$("#opponent_disabled_video").hide():$("#opponent_disabled_video").show()},onLeaveSessionClick=()=>{$("#endSessionDialog").modal()},handleLeaveSession=()=>{for(user in pcPeers)pcPeers[user].close();pcPeers={},App.session.unsubscribe(),remoteVideoContainer&&(remoteVideoContainer.innerHTML=""),broadcastData({type:REMOVE_USER,from:currentUser,to:"CLOSED_SESSION",session_id:seesionId}),localStream.getTracks().forEach(function(e){e.stop()}),Turbolinks.visit("/chests?id="+seesionId+"&profile_id="+currentUser+"&peer_id="+peer_user_id)},handleToggleScreenShare=function(e){var t=document.getElementById("toggle-screen-btn");if(t.classList.contains("active"))t.classList.remove("active"),navigator.mediaDevices.getUserMedia(mediaStreamConstraints).then(function(e){replaceTracks(e),localStream=e,localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e,document.getElementById("toggle-audio-btn").classList.remove("active"),document.getElementById("toggle-video-btn").classList.remove("active")})["catch"](function(){t.classList.toggle("active")});else{if("on-chrome-btn"===e)return;t.classList.add("active"),navigator.mediaDevices.getDisplayMedia&&navigator.mediaDevices.getDisplayMedia(displayMediaStreamConstraints).then(e=>{localStream.getTracks().forEach(function(e){"audio"!==e.kind&&e.stop()}),replaceTracks(e,!0),localStream=e,e.getVideoTracks()[0].onended=function(){handleToggleScreenShare("on-chrome-btn")},localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e})["catch"](function(){t.classList.toggle("active")})}};var currentActiveCamera=0;const handleToggleAudio=function(e){e.forEach(function(e){document.getElementById(e).classList.toggle("active")});var t=localStream.getAudioTracks();if(0!==t.length)for(var o=0;o<t.length;++o)t[o].enabled=!t[o].enabled},handleToggleVideo=function(e){e&&e.forEach(function(e){document.getElementById(e).classList.toggle("active")});var t=localStream.getVideoTracks();if(0!==t.length){for(var o,n=0;n<t.length;++n)t[n].enabled=!t[n].enabled,o=t[n].enabled;broadcastData({type:TOGGLE_VIDEO,from:currentUser,session_id:seesionId,candidate:o}),o?($(".video-background-overlay").hide(),$(".pre-session-switch-camera").prop("disabled",!1)):($(".video-background-overlay").show(),$(".pre-session-switch-camera").prop("disabled","disabled"))}},handleOpenFullscreen=function(){var e=document.querySelector("#remote-video-container video");e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},joinRoom=e=>{createPC(e.from,!0)},removeUser=e=>{console.log("removing user",e.from);let t=document.getElementById(`remoteVideoContainer+${e.from}`);t&&t.remove(),delete pcPeers[e.from],$("div#show").hide(),"CLOSED_SESSION"===e.to&&$("#otherUserEndedSession").modal({backdrop:"static"})},createPC=(e,t)=>{let o=new RTCPeerConnection(ice);return pcPeers[e]=o,o.addStream(localStream),t&&o.createOffer().then(e=>o.setLocalDescription(e)).then(()=>{broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e,sdp:JSON.stringify(o.localDescription)})})["catch"](logError),o.onicecandidate=(t=>{t.candidate&&broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e,candidate:JSON.stringify(t.candidate)})}),o.onaddstream=(t=>{const o=document.createElement("video");o.id=`remoteVideoContainer+${e}`,o.autoplay="autoplay",o.srcObject=t.stream,remoteVideoContainer.appendChild(o),$("div#show").toggle()}),o.oniceconnectionstatechange=(()=>{"disconnected"==o.iceConnectionState&&(console.log("Disconnected:",e),$("#loading").show(),broadcastData({type:REMOVE_USER,from:e,session_id:seesionId}))}),o},exchange=e=>{let t;$("#loading").hide(),t=pcPeers[e.from]?pcPeers[e.from]:createPC(e.from,!1),e.candidate&&iceCandiatesQueue.push(new RTCIceCandidate(JSON.parse(e.candidate))),e.sdp&&(sdp=JSON.parse(e.sdp),t.setRemoteDescription(new RTCSessionDescription(sdp)).then(()=>{iceCandiatesQueue.length&&(iceCandiatesQueue.forEach(function(e){t.addIceCandidate(e)["catch"](logError)}),iceCandiatesQueue.length=0),"offer"===sdp.type&&t.createAnswer().then(e=>t.setLocalDescription(e)).then(()=>{broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e.from,sdp:JSON.stringify(t.localDescription)})})})["catch"](logError))},broadcastData=e=>{fetch("/sessions",{method:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json"}})},logError=e=>console.warn("Whoops! Error:",e);