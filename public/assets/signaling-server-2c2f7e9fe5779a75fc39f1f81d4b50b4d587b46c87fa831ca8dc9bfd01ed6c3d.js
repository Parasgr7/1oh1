function countdown_timer(e){countDownDate=new Date(e).getTime();var t=setInterval(function(){var e=(new Date).getTime(),o=countDownDate-e,n=Math.floor(o/864e5),a=Math.floor(o%864e5/36e5),r=Math.floor(o%36e5/6e4),i=Math.floor(o%6e4/1e3);n=n?n+"d ":"",a=a?a+"h ":"",r=r?r+"m ":"",i=i?i+"s ":"",document.getElementById("demo").innerHTML=n+a+r+i,o<0&&(clearInterval(t),document.getElementById("demo").innerHTML="EXPIRED",$("#timesUp").modal("show"))},1e3)}function switchCameras(){var e=mediaStreamConstraints.video.facingMode;e||(mediaStreamConstraints.video={}),mediaStreamConstraints.video.facingMode="user"===e?"environment":"user",navigator.mediaDevices.getUserMedia(mediaStreamConstraints).then(function(e){replaceTracks(e),localStream=e,localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e})["catch"](function(e){console.log(e)})}function replaceTracks(e){function t(){a.map(function(e){if(e.track){var t=o.find(function(t){return t.kind===e.track.kind});t&&e.replaceTrack(t)}})}var o=e.getTracks(),n=pcPeers[Object.keys(pcPeers)[0]],a=n.getSenders();o.forEach(function(e){localStream.addTrack(e)}),t(n)}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;const JOIN_ROOM="JOIN_ROOM",EXCHANGE="EXCHANGE",REMOVE_USER="REMOVE_USER";var displayMediaStreamConstraints={video:!0,audio:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseReduction:!1}},mediaStreamConstraints={video:{width:screen.width,height:screen.height,aspectRatio:1.77},audio:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseReduction:!1}};let currentUser,remoteVideoContainer,localStream,pcPeers={};window.onload=(()=>{currentUser=document.getElementById("current-user").innerHTML,end_time=document.getElementsByTagName("time")[0].innerHTML,countdown_timer(end_time),seesionId=document.getElementById("session_id").innerHTML,remoteVideoContainer=document.getElementById("remote-video-container"),$("#join-session-btn").attr("disabled",!1)});const ice={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};document.onreadystatechange=(()=>{"interactive"===document.readyState&&navigator.mediaDevices.getUserMedia(mediaStreamConstraints).then(e=>{var t=$("#local-video")[0];localStream=e,t.srcObject=e})["catch"](logError)});const handleJoinSession=async()=>{$(".wrapCardPre").fadeOut(),$("#local-video-up").fadeIn(),localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=localStream,App.session=await App.cable.subscriptions.create({channel:"SessionChannel",session_id:document.getElementById("session_id").innerHTML},{connected:()=>{broadcastData({type:JOIN_ROOM,from:currentUser,session_id:seesionId})},received:e=>{if(console.log("received",e),e.from!==currentUser)switch(e.type){case JOIN_ROOM:return joinRoom(e);case EXCHANGE:if(e.to!==currentUser)return;return exchange(e);case REMOVE_USER:return removeUser(e);default:return}},speak:e=>(console.log("received",e),App.session.perform("speak",{body:e}))})},handleLeaveSession=()=>{for(user in pcPeers)pcPeers[user].close();pcPeers={},App.session.unsubscribe(),remoteVideoContainer.innerHTML="",broadcastData({type:REMOVE_USER,from:currentUser,session_id:seesionId})},handleToggleScreenShare=function(e){var t=document.getElementById("toggle-screen-btn");if(t.classList.contains("active"))t.classList.remove("active"),navigator.mediaDevices.getUserMedia(mediaStreamConstraints).then(function(e){replaceTracks(e),localStream=e,localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e,document.getElementById("toggle-audio-btn").classList.remove("active"),document.getElementById("toggle-video-btn").classList.remove("active")})["catch"](function(){t.classList.toggle("active")});else{if("on-chrome-btn"===e)return;t.classList.add("active"),navigator.mediaDevices.getDisplayMedia&&navigator.mediaDevices.getDisplayMedia(displayMediaStreamConstraints).then(e=>{localStream.getTracks().forEach(function(e){"audio"!==e.kind&&e.stop()}),replaceTracks(e,!0),localStream=e,e.getVideoTracks()[0].onended=function(){handleToggleScreenShare("on-chrome-btn")},localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e})["catch"](function(){t.classList.toggle("active")})}},handleToggleAudio=function(e){e.forEach(function(e){document.getElementById(e).classList.toggle("active")});var t=localStream.getAudioTracks();if(0!==t.length)for(var o=0;o<t.length;++o)t[o].enabled=!t[o].enabled},handleToggleVideo=function(e){e.forEach(function(e){document.getElementById(e).classList.toggle("active")});var t=localStream.getVideoTracks();if(0!==t.length)for(var o=0;o<t.length;++o)t[o].enabled=!t[o].enabled},handleOpenFullscreen=function(){var e=document.querySelector("#remote-video-container video");e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},joinRoom=e=>{createPC(e.from,!0)},removeUser=e=>{console.log("removing user",e.from);let t=document.getElementById(`remoteVideoContainer+${e.from}`);t&&t.remove(),delete pcPeers[e.from],$("div#show").hide()},createPC=(e,t)=>{let o=new RTCPeerConnection(ice);return pcPeers[e]=o,o.addStream(localStream),t&&o.createOffer().then(e=>o.setLocalDescription(e)).then(()=>{broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e,sdp:JSON.stringify(o.localDescription)})})["catch"](logError),o.onicecandidate=(t=>{t.candidate&&broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e,candidate:JSON.stringify(t.candidate)})}),o.onaddstream=(t=>{const o=document.createElement("video");o.id=`remoteVideoContainer+${e}`,o.autoplay="autoplay",o.srcObject=t.stream,remoteVideoContainer.appendChild(o),$("div#show").toggle()}),o.oniceconnectionstatechange=(()=>{"disconnected"==o.iceConnectionState&&(console.log("Disconnected:",e),broadcastData({type:REMOVE_USER,from:e,session_id:seesionId}))}),o},exchange=e=>{let t;t=pcPeers[e.from]?pcPeers[e.from]:createPC(e.from,!1),e.candidate&&t.addIceCandidate(new RTCIceCandidate(JSON.parse(e.candidate))).then(()=>console.log("Ice candidate added"))["catch"](logError),e.sdp&&(sdp=JSON.parse(e.sdp),t.setRemoteDescription(new RTCSessionDescription(sdp)).then(()=>{"offer"===sdp.type&&t.createAnswer().then(e=>t.setLocalDescription(e)).then(()=>{broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e.from,sdp:JSON.stringify(t.localDescription)})})})["catch"](logError))},broadcastData=e=>{fetch("/sessions",{method:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json"}})},logError=e=>console.warn("Whoops! Error:",e);